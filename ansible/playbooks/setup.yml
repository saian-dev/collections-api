- name: Setup server for Collections API
  hosts: local
  become: true
  vars_files:
    - ../vars/main.yml
    - ../vars/secrets.yml
    - ../group_vars/local/vars.yml

  tasks:
    # ———————————————————————————————————————————————————————————————
    # SYSTEM
    # ———————————————————————————————————————————————————————————————
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install system packages
      ansible.builtin.apt:
        name:
          - git
          - curl
          - wget
          - build-essential
          - libpq-dev
          - acl
        state: present

    # ———————————————————————————————————————————————————————————————
    # PYTHON/UV
    # ———————————————————————————————————————————————————————————————
    - name: Add deadsnakes PPA
      ansible.builtin.apt_repository:
        repo: ppa:deadsnakes/ppa
        state: present

    - name: Install Python {{ python.version }}
      ansible.builtin.apt:
        name:
          - python{{ python.version }}
          - python{{ python.version }}-venv
          - python{{ python.version }}-dev
        state: present

    # ———————————————————————————————————————————————————————————————
    # POSTGRESQL
    # ———————————————————————————————————————————————————————————————
    - name: Install psycopg2 for Ansible PostgreSQL module
      ansible.builtin.apt:
        name:
          - python3-psycopg2
        state: present

    - name: Install PostgreSQL
      ansible.builtin.apt:
        name:
          - postgresql
          - postgresql-contrib
        state: present

    - name: Start and enable PostgreSQL
      ansible.builtin.systemd:
        name: postgresql
        state: started
        enabled: true

    - name: Create PostgreSQL user
      become_user: postgres
      community.postgresql.postgresql_user:
        name: "{{ postgres.user }}"
        password: "{{ postgres.password }}"
        state: present

    - name: Create PostgreSQL database
      become_user: postgres
      community.postgresql.postgresql_db:
        name: "{{ postgres.db_name }}"
        owner: "{{ postgres.user }}"
        state: present

    - name: Run SQL queries
      become_user: postgres
      community.postgresql.postgresql_query:
        name: "{{ postgres.db_name }}"
        query: |
          CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
          CREATE EXTENSION IF NOT EXISTS "pg_trgm";
          CREATE EXTENSION IF NOT EXISTS "btree_gin";
      register: query_result

    - name: Check result of SQL queries
      ansible.builtin.debug:
        var: query_result.query_result

    # ———————————————————————————————————————————————————————————————
    # CADDY
    # ———————————————————————————————————————————————————————————————
    - name: Install Caddy dependencies
      ansible.builtin.apt:
        name:
          - debian-keyring
          - debian-archive-keyring
          - apt-transport-https
        state: present

    - name: Add Caddy GPG key
      ansible.builtin.get_url:
        url: https://dl.cloudsmith.io/public/caddy/stable/gpg.key
        dest: /usr/share/keyrings/caddy-stable-archive-keyring.asc
        mode: "0644"

    - name: Add Caddy repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.asc] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main"
        state: present
        filename: caddy-stable

    - name: Install Caddy
      ansible.builtin.apt:
        name: caddy
        state: present
        update_cache: true

    - name: Configure Caddy
      ansible.builtin.template:
        src: ../templates/Caddyfile.j2
        dest: /etc/caddy/Caddyfile
        mode: "0644"
      notify: Restart Caddy

    # ———————————————————————————————————————————————————————————————
    # APPLICATION
    # ———————————————————————————————————————————————————————————————
    - name: Create application group
      ansible.builtin.group:
        name: "{{ app.group }}"
        state: present

    - name: Create application user
      ansible.builtin.user:
        name: "{{ app.user }}"
        group: "{{ app.group }}"
        shell: /bin/bash
        create_home: true
        state: present

    - name: Create application directory
      ansible.builtin.file:
        path: "{{ app.dir }}"
        state: directory
        owner: "{{ app.user }}"
        group: "{{ app.group }}"
        mode: "0755"

    - name: Create systemd service
      ansible.builtin.template:
        src: ../templates/collections-api.service.j2
        dest: /etc/systemd/system/{{ app.name }}.service
        mode: "0644"
      notify:
        - Reload systemd
        - Restart app

    - name: Enable application service
      ansible.builtin.systemd:
        name: "{{ app.name }}"
        enabled: true

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart app
      ansible.builtin.systemd:
        name: "{{ app.name }}"
        state: restarted

    - name: Restart Caddy
      ansible.builtin.systemd:
        name: caddy
        state: restarted
